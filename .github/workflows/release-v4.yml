name: "QCE V4 Release"

on:
  push:
    tags:
      - "v4.*"
      - "v*"

permissions: write-all

jobs:
  Build-QCE-V4-Multi-Platform:
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform: Linux
            arch: x64
            ext: ""
            shell: "bash"
          - os: windows-latest
            platform: Windows
            arch: x64
            ext: ".bat"
            shell: "cmd"
          - os: macos-13
            platform: macOS
            arch: x64
            ext: ""
            shell: "bash"
          - os: macos-latest
            platform: macOS
            arch: arm64
            ext: ""
            shell: "bash"
    
    runs-on: ${{ matrix.os }}
    
    steps:
      - name: Clone Main Repository
        uses: actions/checkout@v4
      
      - name: Use Node.js 20.X
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
      
      # è®¾ç½® pnpmï¼ˆNextJSé¡¹ç›®éœ€è¦ï¼‰
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8
      
      # Unixç³»ç»Ÿæž„å»º (Linux/macOS)
      - name: Build QCE V4 (Unix)
        if: matrix.shell == 'bash'
        env:
          NODE_OPTIONS: "--max-old-space-size=4096"
        run: |
          echo "ðŸš€ Building QCE V4 for ${{ matrix.platform }}-${{ matrix.arch }}"
          
          # æž„å»º QCE V4 å·¥å…·å‰ç«¯
          echo "ðŸ“¦ Building QCE V4 Tool frontend..."
          cd qce-v4-tool
          pnpm install
          NODE_ENV=production pnpm run build
          cd ..
          
          # æž„å»º NapCat ä¸»ä½“
          echo "ðŸ“¦ Building NapCat..."
          cd NapCatQQ
          npm install
          cd napcat.webui && npm install --force && cd ..
          npm run build:universal
          cd dist && npm install --omit=dev && cd ..
          echo "âœ… Build completed for ${{ matrix.platform }}"
      
      # ä¸º macOS ä¸‹è½½å¹¶æ‰“åŒ… Node.js è¿è¡Œæ—¶
      - name: Bundle Node.js Runtime for macOS
        if: matrix.platform == 'macOS'
        run: |
          echo "ðŸ“¥ ä¸‹è½½ Node.js 20 LTS è¿è¡Œæ—¶ç”¨äºŽ macOS..."
          cd NapCatQQ/dist
          mkdir -p bin
          
          # ä¸‹è½½ Node.js 20 LTS (arm64)
          echo "â¬‡ï¸ ä¸‹è½½ Node.js 20 arm64..."
          curl -fsSL https://nodejs.org/dist/v20.18.0/node-v20.18.0-darwin-arm64.tar.gz -o node-arm64.tar.gz
          tar -xzf node-arm64.tar.gz
          cp node-v20.18.0-darwin-arm64/bin/node bin/node-darwin-arm64
          chmod +x bin/node-darwin-arm64
          rm -rf node-arm64.tar.gz node-v20.18.0-darwin-arm64
          
          # ä¸‹è½½ Node.js 20 LTS (x64)
          echo "â¬‡ï¸ ä¸‹è½½ Node.js 20 x64..."
          curl -fsSL https://nodejs.org/dist/v20.18.0/node-v20.18.0-darwin-x64.tar.gz -o node-x64.tar.gz
          tar -xzf node-x64.tar.gz
          cp node-v20.18.0-darwin-x64/bin/node bin/node-darwin-x64
          chmod +x bin/node-darwin-x64
          rm -rf node-x64.tar.gz node-v20.18.0-darwin-x64
          
          echo "âœ… Node.js è¿è¡Œæ—¶å·²æ‰“åŒ…ï¼š"
          ls -lh bin/
          file bin/node-darwin-arm64
          file bin/node-darwin-x64
      
      # Windowsæž„å»º
      - name: Build QCE V4 (Windows)
        if: matrix.shell == 'cmd'
        env:
          NODE_OPTIONS: "--max-old-space-size=4096"
        run: |
          echo "ðŸš€ Building QCE V4 for Windows-x64"
          
          echo "ðŸ“¦ Building QCE V4 Tool frontend..."
          cd qce-v4-tool
          pnpm install
          set NODE_ENV=production && pnpm run build
          cd ..
          
          echo "ðŸ“¦ Building NapCat..."
          cd NapCatQQ
          npm install
          cd napcat.webui
          npm install --force
          cd ..
          npm run build:universal
          cd dist
          npm install --omit=dev
          cd ..
          echo "âœ… Build completed for Windows"
      
      # åˆ›å»ºå¹³å°ç‰¹å®šçš„å¯åŠ¨è„šæœ¬
      - name: Create Platform Launcher (Unix)
        if: matrix.shell == 'bash'
        run: |
          cd NapCatQQ/dist
          # åˆ›å»ºUnixå¯åŠ¨è„šæœ¬
          cat > napcat-launcher.sh << 'EOFSCRIPT'
          #!/usr/bin/env bash
          set -euo pipefail
          
          # -------------------------------
          # QQ Chat Exporter - macOS/Linux Launcher (Hardened)
          # Build Platform: ${{ matrix.platform }}-${{ matrix.arch }}
          # -------------------------------
          
          # ---- Logging helpers ----
          log_info()  { printf "\033[1;34m[info]\033[0m %s\n" "$*"; }
          log_warn()  { printf "\033[1;33m[warn]\033[0m %s\n" "$*"; }
          log_error() { printf "\033[1;31m[error]\033[0m %s\n" "$*"; }
          die()       { log_error "$*"; exit 1; }
          
          # ---- Paths ----
          SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
          BIN_DIR="${SCRIPT_DIR}/bin"
          
          # ç”¨æˆ·å¯é€šè¿‡çŽ¯å¢ƒå˜é‡è¦†å†™ QQ è·¯å¾„
          QQ_BIN_DEFAULT="/Applications/QQ.app/Contents/MacOS/QQ"
          QQ_BIN="${NAPCAT_QQ_PATH:-$QQ_BIN_DEFAULT}"
          
          # NapCat å…¥å£
          NAPCAT_ENTRY="${SCRIPT_DIR}/napcat.mjs"
          
          # ---- Detect platform ----
          if [[ "$OSTYPE" == "darwin"* ]]; then
              PLATFORM="macOS"
          elif [[ "$OSTYPE" == "linux-gnu"* ]]; then
              PLATFORM="Linux"
          else
              PLATFORM="Unix"
          fi
          
          log_info "å¯åŠ¨ NapCat QCE V4..."
          log_info "æž„å»ºå¹³å°: ${{ matrix.platform }}-${{ matrix.arch }}"
          log_info "è¿è¡Œå¹³å°: ${PLATFORM}"
          log_info "ç³»ç»Ÿæž¶æž„: $(uname -m)"
          
          # ---- macOS specific handling ----
          if [[ "$PLATFORM" == "macOS" ]]; then
              log_info "ðŸŽ macOS çŽ¯å¢ƒæ£€æµ‹..."
              
              # Sanity checks
              [[ -f "$NAPCAT_ENTRY" ]] || die "æœªæ‰¾åˆ° NapCat å…¥å£: $NAPCAT_ENTRY"
              
              # Quarantine cleanup (first run)
              if command -v xattr >/dev/null 2>&1; then
                if xattr "$SCRIPT_DIR" 2>/dev/null | grep -q com.apple.quarantine; then
                  log_warn "ç§»é™¤éš”ç¦»å±žæ€§ï¼ˆquarantineï¼‰ï¼Œä»¥å…é¦–æ¬¡è¿è¡Œè¢«æ‹¦æˆª..."
                  xattr -r -d com.apple.quarantine "$SCRIPT_DIR" || true
                fi
              fi
              
              # Detect QQ path
              if [ -n "$NAPCAT_QQ_PATH" ] && [ -f "$NAPCAT_QQ_PATH" ]; then
                  log_info "âœ… ä½¿ç”¨çŽ¯å¢ƒå˜é‡æŒ‡å®šçš„QQè·¯å¾„: $NAPCAT_QQ_PATH"
              else
                  log_info "ðŸ” æ­£åœ¨æœç´¢ QQ.app..."
                  
                  # Try common paths
                  qq_app_paths=(
                      "/Applications/QQ.app"
                      "$HOME/Applications/QQ.app"
                      "/System/Applications/QQ.app"
                  )
                  
                  found=0
                  for app_path in "${qq_app_paths[@]}"; do
                      if [ -d "$app_path" ]; then
                          qq_binary="$app_path/Contents/MacOS/QQ"
                          if [ -f "$qq_binary" ]; then
                              NAPCAT_QQ_PATH="$qq_binary"
                              export NAPCAT_QQ_PATH
                              log_info "âœ… æ‰¾åˆ° QQ: $NAPCAT_QQ_PATH"
                              found=1
                              break
                          fi
                      fi
                  done
                  
                  # Try mdfind
                  if [[ $found -eq 0 ]] && command -v mdfind >/dev/null 2>&1; then
                      found_app=$(mdfind 'kMDItemCFBundleIdentifier == "com.tencent.qq"' 2>/dev/null | head -n 1)
                      if [ -n "$found_app" ] && [ -d "$found_app" ]; then
                          qq_binary="$found_app/Contents/MacOS/QQ"
                          if [ -f "$qq_binary" ]; then
                              NAPCAT_QQ_PATH="$qq_binary"
                              export NAPCAT_QQ_PATH
                              log_info "âœ… æ‰¾åˆ° QQ: $NAPCAT_QQ_PATH"
                              found=1
                          fi
                      fi
                  fi
                  
                  if [[ $found -eq 0 ]]; then
                      log_error "âŒ æœªæ‰¾åˆ° QQ.appï¼Œè¯·ï¼š"
                      log_error "   1. ç¡®ä¿å·²å®‰è£… QQ for Mac"
                      log_error "   2. æˆ–æ‰‹åŠ¨æŒ‡å®šè·¯å¾„ï¼š"
                      log_error "      export NAPCAT_QQ_PATH=\"/Applications/QQ.app/Contents/MacOS/QQ\""
                      log_error "      ./napcat-launcher.sh"
                      exit 1
                  fi
              fi
              
              # Detect archs
              HOST_UNAME="$(uname -m)"
              QQ_FILE_DESC="$(file -b "$NAPCAT_QQ_PATH" 2>/dev/null || echo 'unknown')"
              
              log_info "QQ Binary: ${NAPCAT_QQ_PATH}"
              log_info "QQ File:   ${QQ_FILE_DESC}"
              
              # Bundled Node candidates
              NODE_ARM64="${BIN_DIR}/node-darwin-arm64"
              NODE_X64="${BIN_DIR}/node-darwin-x64"
              
              # Rosetta availability (only on Apple Silicon)
              ROSETTA_OK=0
              if [[ "$HOST_UNAME" == "arm64" ]] && command -v arch >/dev/null 2>&1; then
                if arch -x86_64 /usr/bin/true 2>/dev/null; then
                  ROSETTA_OK=1
                  log_info "Rosetta 2 å¯ç”¨"
                fi
              fi
              
              # Decide runtime strategy
              run_napcat() {
                local runtime_prefix=() node_bin="$1" arch_tag="$2"
              
                # å¦‚æžœéœ€è¦ Rosettaï¼Œåˆ™åŒ…ä¸€å±‚ arch -x86_64
                if [[ "$arch_tag" == "x64" ]]; then
                  if [[ "$HOST_UNAME" == "arm64" ]]; then
                    [[ $ROSETTA_OK -eq 1 ]] || die "éœ€è¦ Rosetta æ‰èƒ½è¿è¡Œ x64 Nodeï¼Œä½†å½“å‰ç³»ç»Ÿä¸å¯ç”¨ã€‚è¯·å®‰è£… Rosettaã€‚"
                    runtime_prefix=(arch -x86_64)
                  fi
                fi
              
                log_info "ä½¿ç”¨ Node: ${node_bin} (${arch_tag})"
                "${runtime_prefix[@]}" "$node_bin" -v || die "æ— æ³•æ‰§è¡Œ Node: ${node_bin}"
              
                # Node ä¸»ç‰ˆæœ¬æç¤º
                local major
                major="$("${runtime_prefix[@]}" "$node_bin" -p "process.version.split('.')[0].slice(1)" 2>/dev/null || echo '0')"
                if [[ "$major" -ne 20 ]]; then
                  log_warn "å½“å‰ Node ä¸»ç‰ˆæœ¬ä¸º ${major}ï¼Œå»ºè®®ä½¿ç”¨ 20 ä»¥èŽ·å¾—æœ€ä½³å…¼å®¹æ€§ã€‚"
                fi
              
                # å®žé™…å¯åŠ¨
                log_info "ðŸš€ å¯åŠ¨ NapCat..."
                "${runtime_prefix[@]}" "$node_bin" "$NAPCAT_ENTRY" "$@"
              }
              
              # Try run with bundled node first
              if [[ "$HOST_UNAME" == "arm64" ]]; then
                if [[ "${NAPCAT_FORCE_X64:-0}" -eq 1 ]]; then
                  [[ -x "$NODE_X64" ]] || die "å·²å¼ºåˆ¶ x64ï¼Œä½†ç¼ºå°‘ ${NODE_X64}"
                  run_napcat "$NODE_X64" "x64" "$@"
                  exit 0
                fi
              
                if [[ -x "$NODE_ARM64" ]]; then
                  log_info "å°è¯•ä½¿ç”¨ arm64 éšåŒ… Node..."
                  if run_napcat "$NODE_ARM64" "arm64" "$@" 2>&1; then
                    exit 0
                  else
                    log_warn "arm64 Node å¯åŠ¨å¤±è´¥ï¼Œå°è¯• x64 (Rosetta)..."
                  fi
                fi
              
                # å›žé€€ Rosetta x64
                if [[ -x "$NODE_X64" ]]; then
                  log_warn "ä½¿ç”¨ Rosetta x64 Node ä»¥æé«˜ wrapper.node å…¼å®¹æ€§..."
                  run_napcat "$NODE_X64" "x64" "$@"
                  exit 0
                fi
              else
                # Intel Mac
                if [[ -x "$NODE_X64" ]]; then
                  run_napcat "$NODE_X64" "x64" "$@"
                  exit 0
                fi
              fi
              
              # Final fallback: system node (not recommended)
              if command -v node >/dev/null 2>&1; then
                log_warn "âš ï¸  æœªæ‰¾åˆ°éšåŒ… Nodeï¼Œå›žé€€ä½¿ç”¨ç³»ç»Ÿ Nodeï¼ˆå¯èƒ½å¯¼è‡´ dyld é”™è¯¯ï¼‰"
                log_warn "ç³»ç»Ÿ Node ç‰ˆæœ¬: $(node -v)"
                log_warn "ç³»ç»Ÿ Node æž¶æž„: $(node -p 'process.arch')"
                log_info "ðŸš€ å¯åŠ¨ NapCat..."
                node "$NAPCAT_ENTRY" "$@"
              else
                die "ç¼ºå°‘éšåŒ… Nodeï¼Œä¸”ç³»ç»Ÿä¸­ä¹Ÿæœªæ‰¾åˆ° nodeã€‚è¯·å®‰è£… Node 20 æˆ–è”ç³»å¼€å‘è€…ã€‚"
              fi
          
          # ---- Linux specific handling ----
          elif [[ "$PLATFORM" == "Linux" ]]; then
              log_info "ðŸ§ Linux çŽ¯å¢ƒæ£€æµ‹..."
              
              [[ -f "$NAPCAT_ENTRY" ]] || die "æœªæ‰¾åˆ° NapCat å…¥å£: $NAPCAT_ENTRY"
              
              # æ£€æµ‹QQå®‰è£…è·¯å¾„
              if [ -f "./resources/app/package.json" ]; then
                  log_info "âœ… æ£€æµ‹åˆ°åœ¨QQå®‰è£…ç›®å½•ä¸­è¿è¡Œ"
                  QQ_DIR="$(pwd)"
              elif [ -n "$NAPCAT_QQ_PATH" ] && [ -d "$NAPCAT_QQ_PATH" ]; then
                  log_info "âœ… ä½¿ç”¨çŽ¯å¢ƒå˜é‡æŒ‡å®šçš„QQè·¯å¾„: $NAPCAT_QQ_PATH"
                  QQ_DIR="$(dirname "$NAPCAT_QQ_PATH")"
              else
                  log_info "ðŸ” æ­£åœ¨æœç´¢QQå®‰è£…è·¯å¾„..."
                  
                  qq_paths=(
                      "/opt/QQ"
                      "/usr/local/bin/qq"
                      "/snap/qq/current"
                      "/var/lib/flatpak/app/com.qq.QQ/current/active/files"
                  )
                  
                  found=0
                  for path in "${qq_paths[@]}"; do
                      if [ -d "$path" ] && [ -f "$path/resources/app/package.json" ]; then
                          QQ_DIR="$path"
                          log_info "âœ… æ‰¾åˆ°QQå®‰è£…è·¯å¾„: $QQ_DIR"
                          found=1
                          break
                      fi
                  done
                  
                  if [[ $found -eq 0 ]]; then
                      log_error "âŒ æœªæ‰¾åˆ°QQå®‰è£…ï¼Œè¯·ï¼š"
                      log_error "   1. ç¡®ä¿å·²å®‰è£…Linuxç‰ˆQQ"
                      log_error "   2. å°†NapCatè§£åŽ‹åˆ°QQå®‰è£…ç›®å½• (/opt/QQ) ä¸­è¿è¡Œ"
                      log_error "   3. æˆ–è®¾ç½®çŽ¯å¢ƒå˜é‡: export NAPCAT_QQ_PATH=/path/to/qq"
                      exit 1
                  fi
              fi
              
              # è®¾ç½®åŠ¨æ€åº“æœç´¢è·¯å¾„
              export LD_LIBRARY_PATH="$QQ_DIR/resources/app:$QQ_DIR:${LD_LIBRARY_PATH:-}"
              log_info "ðŸ“š è®¾ç½®åº“è·¯å¾„: $LD_LIBRARY_PATH"
              
              # åˆ‡æ¢åˆ°QQç›®å½•è¿è¡Œï¼ˆé‡è¦ï¼ï¼‰
              cd "$QQ_DIR"
              log_info "ðŸ“ åˆ‡æ¢åˆ°QQç›®å½•: $(pwd)"
              log_info "ðŸš€ å¯åŠ¨ NapCat..."
              
              # Linux ä½¿ç”¨ç³»ç»Ÿ Nodeï¼ˆå› ä¸ºéœ€è¦ä¸Ž QQ çš„åŠ¨æ€åº“å…¼å®¹ï¼‰
              if command -v node >/dev/null 2>&1; then
                  log_info "Node ç‰ˆæœ¬: $(node -v)"
                  log_info "Node æž¶æž„: $(node -p 'process.arch')"
                  node "$SCRIPT_DIR/napcat.mjs" "$@"
              else
                  die "æœªæ‰¾åˆ° node å‘½ä»¤ï¼Œè¯·å®‰è£… Node.js 20+"
              fi
          
          # ---- Other Unix ----
          else
              log_info "å¯åŠ¨ NapCat (é€šç”¨ Unix)..."
              [[ -f "$NAPCAT_ENTRY" ]] || die "æœªæ‰¾åˆ° NapCat å…¥å£: $NAPCAT_ENTRY"
              
              if command -v node >/dev/null 2>&1; then
                  log_info "Node ç‰ˆæœ¬: $(node -v)"
                  log_info "ðŸš€ å¯åŠ¨ NapCat..."
                  node "$NAPCAT_ENTRY" "$@"
              else
                  die "æœªæ‰¾åˆ° node å‘½ä»¤ï¼Œè¯·å®‰è£… Node.js"
              fi
          fi
          EOFSCRIPT
          
          chmod +x napcat-launcher.sh
          echo "âœ… Created hardened launcher script for ${{ matrix.platform }}-${{ matrix.arch }}"
      
      - name: Create Platform Launcher (Windows)
        if: matrix.shell == 'cmd'
        run: |
          cd NapCatQQ/dist
          # Windowså¹³å°å·²åŒ…å«åŽŸç”Ÿlauncher.batæ–‡ä»¶ï¼Œæ— éœ€åˆ›å»ºé¢å¤–å¯åŠ¨è„šæœ¬
          echo "âœ… Windows platform uses existing launcher.bat files"
          
          echo "âœ… Created CLI launcher script for Windows"
      
      - name: Package Distribution (Unix)
        if: matrix.shell == 'bash'
        run: |
          cd NapCatQQ/dist
          # åˆ›å»ºç‰ˆæœ¬ä¿¡æ¯æ–‡ä»¶
          cat > VERSION.txt << EOF
          NapCat QCE V4
          Version: ${{ github.ref_name }}
          Platform: ${{ matrix.platform }}-${{ matrix.arch }}
          Build Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          Build Commit: ${{ github.sha }}
          
          Features:
          - QQ Chat Exporter V4
          - Web UI Management
          - Multi-format Export (HTML/JSON/TXT)
          - Resource Management
          - CLI Support
          
          Usage:
          - Linux: å°†æ–‡ä»¶è§£åŽ‹åˆ°QQå®‰è£…ç›®å½• (/opt/QQ) åŽè¿è¡Œ ./napcat-launcher.sh
          - macOS: ç›´æŽ¥è¿è¡Œ ./napcat-launcher.sh  
          - æˆ–è®¾ç½®çŽ¯å¢ƒå˜é‡: export NAPCAT_QQ_PATH=/path/to/qq
          - Web UI: http://localhost:40653
          - QCE Tool: http://localhost:40653/qce-v4-tool
          EOF
          
          echo "ðŸ“¦ Created version info file"
          ls -la
      
      - name: Package Distribution (Windows)
        if: matrix.shell == 'cmd'
        shell: pwsh
        run: |
          cd NapCatQQ/dist
          "NapCat QCE V4" | Out-File -FilePath VERSION.txt -Encoding UTF8
          "Version: ${{ github.ref_name }}" | Out-File -FilePath VERSION.txt -Append -Encoding UTF8
          "Platform: ${{ matrix.platform }}-${{ matrix.arch }}" | Out-File -FilePath VERSION.txt -Append -Encoding UTF8
          "Build Date: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')" | Out-File -FilePath VERSION.txt -Append -Encoding UTF8
          "Build Commit: ${{ github.sha }}" | Out-File -FilePath VERSION.txt -Append -Encoding UTF8
          "" | Out-File -FilePath VERSION.txt -Append -Encoding UTF8
          "Features:" | Out-File -FilePath VERSION.txt -Append -Encoding UTF8
          "- QQ Chat Exporter V4" | Out-File -FilePath VERSION.txt -Append -Encoding UTF8
          "- Web UI Management" | Out-File -FilePath VERSION.txt -Append -Encoding UTF8
          "- Multi-format Export (HTML/JSON/TXT)" | Out-File -FilePath VERSION.txt -Append -Encoding UTF8
          "- Resource Management" | Out-File -FilePath VERSION.txt -Append -Encoding UTF8
          "- CLI Support" | Out-File -FilePath VERSION.txt -Append -Encoding UTF8
          "" | Out-File -FilePath VERSION.txt -Append -Encoding UTF8
          "Usage:" | Out-File -FilePath VERSION.txt -Append -Encoding UTF8
          "- Run: launcher-user.bat" | Out-File -FilePath VERSION.txt -Append -Encoding UTF8
          "- Web UI: http://localhost:40653" | Out-File -FilePath VERSION.txt -Append -Encoding UTF8
          "- QCE Tool: http://localhost:40653/qce-v4-tool" | Out-File -FilePath VERSION.txt -Append -Encoding UTF8
          
          Write-Output "ðŸ“¦ Created version info file"
          Get-ChildItem
      
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: NapCat.QCE.V4-${{ matrix.platform }}-${{ matrix.arch }}
          path: NapCatQQ/dist

  release-qce-v4:
    needs: [Build-QCE-V4-Multi-Platform]
    runs-on: ubuntu-latest
    steps:
      - name: Clone Main Repository
        uses: actions/checkout@v4

      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        
      - name: Extract version from tag
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_ENV
      
      - name: Package Releases
        run: |
          echo "ðŸ“¦ Packaging QCE V4 releases..."
          
          # ä¸ºæ¯ä¸ªå¹³å°åˆ›å»ºåŽ‹ç¼©åŒ…
          for platform_dir in NapCat.QCE.V4-*; do
            if [ -d "$platform_dir" ]; then
              platform_name=$(echo "$platform_dir" | sed 's/NapCat\.QCE\.V4-//')
              echo "Packaging $platform_name..."
              
              cd "$platform_dir"
              if [[ "$platform_name" == *"Windows"* ]]; then
                zip -q -r "../NapCat.QCE.V4-${platform_name}.zip" .
              else
                tar -czf "../NapCat.QCE.V4-${platform_name}.tar.gz" .
              fi
              cd ..
              
              echo "âœ… Created package for $platform_name"
            fi
          done
          
          # åˆ›å»ºé€šç”¨åŒ…ï¼ˆæ‰€æœ‰å¹³å°ï¼‰
          mkdir -p NapCat.QCE.V4-Universal
          cp -r NapCat.QCE.V4-*/* NapCat.QCE.V4-Universal/ 2>/dev/null || true
          cd NapCat.QCE.V4-Universal
          zip -q -r ../NapCat.QCE.V4-Universal.zip .
          cd ..
          
          echo "ðŸ“‹ Available packages:"
          ls -la *.zip *.tar.gz 2>/dev/null || true

      - name: Create Release Notes
        run: |
          cat > CHANGELOG.md << EOF
          # QQ Chat Exporter V4 - Version ${{ env.VERSION }}
          
          ## ä¸‹è½½è¯´æ˜Ž
          
          è¯·æ ¹æ®æ‚¨çš„å¹³å°é€‰æ‹©å¯¹åº”çš„å®‰è£…åŒ…ï¼š
          - **Windows**: \`NapCat.QCE.V4-Windows-x64.zip\`
          - **macOS Apple Silicon (M1/M2/M3)**: \`NapCat.QCE.V4-macOS-arm64.tar.gz\` 
          - **macOS Intel**: \`NapCat.QCE.V4-macOS-x64.tar.gz\`
          - **Linux**: \`NapCat.QCE.V4-Linux-x64.tar.gz\`
          - **é€šç”¨åŒ…**: \`NapCat.QCE.V4-Universal.zip\` (åŒ…å«æ‰€æœ‰å¹³å°)
          
          ## å¿«é€Ÿå¼€å§‹
          
          1. ä¸‹è½½å¹¶è§£åŽ‹å¯¹åº”å¹³å°çš„å®‰è£…åŒ…
          2. **Linuxç”¨æˆ·**: å°†è§£åŽ‹åŽçš„æ–‡ä»¶æ”¾å…¥QQå®‰è£…ç›®å½• (/opt/QQ)
          3. è¿è¡Œå¯åŠ¨è„šæœ¬ï¼š
             - Windows: \`launcher-user.bat\`
             - Linux: åœ¨QQç›®å½•ä¸­è¿è¡Œ \`./napcat-launcher.sh\`
             - macOS: \`./napcat-launcher.sh\` (é¦–æ¬¡è¿è¡Œå¯èƒ½éœ€è¦ç§»é™¤éš”ç¦»å±žæ€§)
          4. åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ http://localhost:40653
          5. è®¿é—® QCE V4 å·¥å…·: http://localhost:40653/qce-v4-tool
          
          ### Linuxç‰¹åˆ«è¯´æ˜Ž
          
          **é‡è¦**: Linuxç”¨æˆ·å¿…é¡»å°†NapCatæ”¾åœ¨QQå®‰è£…ç›®å½•ä¸­è¿è¡Œï¼Œæˆ–è®¾ç½®çŽ¯å¢ƒå˜é‡:
          \`\`\`bash
          # æ–¹æ³•1: è§£åŽ‹åˆ°QQç›®å½• (æŽ¨è)
          cd /opt/QQ
          tar -xzf NapCat.QCE.V4-Linux-x64.tar.gz
          ./napcat-launcher.sh
          
          # æ–¹æ³•2: è®¾ç½®çŽ¯å¢ƒå˜é‡
          export NAPCAT_QQ_PATH=/opt/QQ/qq
          ./napcat-launcher.sh
          \`\`\`
          
          ## é‡è¦å£°æ˜Ž
          
          æœ¬è½¯ä»¶å®Œå…¨å…è´¹å¼€æºï¼å¦‚æžœæ‚¨ä»˜è´¹è´­ä¹°äº†æ­¤è½¯ä»¶ï¼Œè¯·ç«‹å³ç”³è¯·é€€æ¬¾å¹¶ä¸¾æŠ¥é”€å”®è€…ã€‚
          
          EOF
        
      - name: Create Release Draft and Upload Artifacts
        uses: softprops/action-gh-release@v1
        with:
          name: NapCat QCE V${{ env.VERSION }}
          token: ${{ secrets.GITHUB_TOKEN }}
          body_path: CHANGELOG.md
          files: |
            NapCat.QCE.V4-Windows-x64.zip
            NapCat.QCE.V4-macOS-x64.tar.gz
            NapCat.QCE.V4-macOS-arm64.tar.gz
            NapCat.QCE.V4-Linux-x64.tar.gz
            NapCat.QCE.V4-Universal.zip
          draft: false
          prerelease: ${{ contains(github.ref_name, 'alpha') || contains(github.ref_name, 'beta') || contains(github.ref_name, 'rc') }}
