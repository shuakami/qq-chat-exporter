name: 发布 NapCat + QCE 完整包

on:
  push:
    tags:
      - 'v*.*.*'
      - 'v*.*.*-alpha.*'
      - 'v*.*.*-beta.*'
      - 'v*.*.*-rc.*'
  workflow_dispatch:

permissions: write-all

jobs:
  get-napcat-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.version }}
    steps:
      - name: "[x] 获取 NapCat 最新版本"
        id: get_version
        run: |
          NAPCAT_VERSION=$(curl -s https://api.github.com/repos/NapNeko/NapCatQQ/releases/latest | jq -r '.tag_name')
          if [ -z "$NAPCAT_VERSION" ] || [ "$NAPCAT_VERSION" == "null" ]; then
            echo "无法获取最新版本，使用默认版本"
            NAPCAT_VERSION="v4.8.119"
          fi
          echo "version=${NAPCAT_VERSION}" >> $GITHUB_OUTPUT
          echo "检测到 NapCat 版本: ${NAPCAT_VERSION}"

  build-shell-packages:
    strategy:
      matrix:
        include:
          - os: windows-latest
            platform: Windows
            arch: x64
            artifact_ext: zip
          - os: ubuntu-latest
            platform: Linux
            arch: x64
            artifact_ext: tar.gz
    
    runs-on: ${{ matrix.os }}
    
    steps:
      - name: "[1/5] Checkout repository"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: "[2/5] Setup Node.js & pnpm"
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
      
      - name: "[3/5] Setup pnpm"
        uses: pnpm/action-setup@v4
        with:
          version: 8
      
      - name: "[4/5] Sync version from tag"
        run: |
          VERSION="${GITHUB_REF#refs/tags/}"
          node scripts/sync-version.js "$VERSION"
        shell: bash
      
      - name: "[5/5] Build Shell package"
        run: python${{ matrix.platform == 'Windows' && '' || '3' }} scripts/quick-pack.py
        shell: bash
        env:
          NODE_ENV: production
          NODE_OPTIONS: --max-old-space-size=4096
          QCE_VERSION: ${{ github.ref_name }}
      
      - name: "[x] 上传 Shell 构建产物"
        uses: actions/upload-artifact@v4
        with:
          name: NapCat-QCE-${{ matrix.platform }}-${{ matrix.arch }}
          path: NapCat-QCE-${{ matrix.platform }}-${{ matrix.arch }}-${{ github.ref_name }}.${{ matrix.artifact_ext }}
          retention-days: 7

  build-framework-package:
    runs-on: ubuntu-latest
    
    steps:
      - name: "[1/5] Checkout repository"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: "[2/5] Setup Node.js & pnpm"
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
      
      - name: "[3/5] Setup pnpm"
        uses: pnpm/action-setup@v4
        with:
          version: 8
      
      - name: "[4/5] Build Frontend"
        run: |
          cd qce-v4-tool
          pnpm install
          pnpm run build
      
      - name: "[5/5] Build Framework package"
        run: python3 scripts/build-framework-plugin.py
        env:
          NODE_ENV: production
          QCE_VERSION: ${{ github.ref_name }}
      
      - name: "[x] 上传 Framework 构建产物"
        uses: actions/upload-artifact@v4
        with:
          name: NapCat-Framework-QCE
          path: NapCat-Framework-QCE-*.zip
          retention-days: 7

  create-release:
    needs: [get-napcat-version, build-shell-packages, build-framework-package]
    runs-on: ubuntu-latest
    
    steps:
      - name: "[1/5] 检出仓库"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: "[2/5] 下载所有构建产物"
        uses: actions/download-artifact@v4
        with:
          path: artifacts/
      
      - name: "[3/5] 准备发布文件"
        run: |
          mkdir -p release-files
          find artifacts/NapCat-QCE-Windows-x64 -type f -name "*.zip" -exec cp {} release-files/ \; 2>/dev/null || true
          find artifacts/NapCat-QCE-Linux-x64 -type f -name "*.tar.gz" -exec cp {} release-files/ \; 2>/dev/null || true
          find artifacts/NapCat-Framework-QCE -type f -name "*.zip" -exec cp {} release-files/ \; 2>/dev/null || true
          echo "发布文件列表："
          ls -lh release-files/
      
      - name: "[4/5] 生成发布说明"
        id: release_notes
        run: |
          VERSION="${GITHUB_REF#refs/tags/}"
          NAPCAT_VERSION="${{ needs.get-napcat-version.outputs.version }}"
          
          PRERELEASE_WARNING=""
          if [[ "$VERSION" == *"alpha"* ]] || [[ "$VERSION" == *"beta"* ]] || [[ "$VERSION" == *"rc"* ]]; then
            PRERELEASE_WARNING=$'> [!TIP]\n> **'"${VERSION}"' 为 Beta 版本**，包含大量新功能但可能存在未知问题。如追求稳定，请使用 [最新稳定版](https://github.com/shuakami/qq-chat-exporter/releases?q=NOT+beta+NOT+alpha+NOT+rc&expanded=true)\n'
          fi
          
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          
          CHANGELOG=""
          if [ -n "$PREV_TAG" ]; then
            for commit in $(git log ${PREV_TAG}..HEAD --format="%H" --reverse); do
              subject=$(git log -1 --format="%s" $commit)
              body=$(git log -1 --format="%b" $commit | sed '/^$/d')
              if [ -n "$body" ]; then
                CHANGELOG="${CHANGELOG}

**${subject}**

${body}"
              else
                CHANGELOG="${CHANGELOG}
- ${subject}"
              fi
            done
          else
            CHANGELOG="- 首次发布完整集成包"
          fi
          
          cat > RELEASE_NOTES.md << 'EOFMARKER'
集成了 NapCat 和 QQ 聊天记录导出插件的开箱即用完整包。所有依赖已安装完毕，配置文件已预配置好，解压后直接运行即可使用。

EOFMARKER

          echo "${PRERELEASE_WARNING}" >> RELEASE_NOTES.md
          echo "### ${VERSION} 更新内容" >> RELEASE_NOTES.md
          echo "${CHANGELOG}" >> RELEASE_NOTES.md
          
          cat >> RELEASE_NOTES.md << EOFMARKER

### 下载

| 包类型 | 平台 | 说明 | 文件 |
|--------|------|------|------|
| **Shell 模式** | Windows x64 | 独立无头 QQ，适合服务器/自动化 | \`NapCat-QCE-Windows-x64-${VERSION}.zip\` |
| **Shell 模式** | Linux x64 | 独立无头 QQ，适合服务器/Docker | \`NapCat-QCE-Linux-x64-${VERSION}.tar.gz\` |
| **Framework 模式** | 跨平台 | LiteLoader 插件，与 QQNT 共存 | \`NapCat-Framework-QCE-${VERSION}.zip\` |

> **如何选择？**
> - **Shell 模式**：独立运行，需要单独登录 QQ，适合服务器部署和自动化备份
> - **Framework 模式**：作为 QQNT 插件运行，与正在使用的 QQ 共享登录，适合 Windows 桌面用户

<details>
<summary>Shell 模式使用方法</summary>

**完整模式**（需要登录QQ，支持导出新记录）：
- **Windows**：解压后运行 \`launcher-user.bat\`
- **Linux**：运行 \`./launcher-user.sh\`

**独立模式**（无需登录QQ，仅浏览已导出文件）：
- **Windows**：运行 \`start-standalone.bat\`
- **Linux**：运行 \`./start-standalone.sh\`

启动后浏览器访问 \`http://localhost:40653/qce-v4-tool\`，完整模式需输入控制台显示的访问令牌。

</details>

<details>
<summary>Framework 模式使用方法</summary>

1. 安装 [LiteLoaderQQNT](https://liteloaderqqnt.github.io/)
2. 将解压后的文件夹复制到 LiteLoader 插件目录：
   - Windows: \`%APPDATA%/LiteLoaderQQNT/plugins/NapCat/\`
   - Linux: \`~/.config/LiteLoaderQQNT/plugins/NapCat/\`
3. 重启 QQNT
4. 访问 \`http://localhost:40653/qce-v4-tool\`

</details>

<details>
<summary>系统要求</summary>

需要 QQ 客户端版本 34606 以上（推荐 9.9.19-34740），[下载地址](https://im.qq.com/)

- **Windows**：Windows 10/11 x64。如提示缺少 DLL，安装 [Visual C++ 运行库](https://aka.ms/vs/17/release/vc_redist.x64.exe)
- **Linux**：Ubuntu 20.04+ / Debian 11+ / CentOS 8+，glibc 2.31+
- **macOS**：⚠️ 因兼容性问题暂不支持

</details>

本软件完全免费开源，遵循 GPL-3.0 协议。如果有人向你收费，立即申请退款并举报。

[使用文档](https://deepwiki.com/shuakami/qq-chat-exporter) | [问题反馈](https://github.com/shuakami/qq-chat-exporter/issues) | [NapCat 项目](https://github.com/NapNeko/NapCatQQ)

### Contributors

<a href="https://github.com/shuakami/qq-chat-exporter/graphs/contributors">
  <img src="https://contrib.rocks/image?repo=shuakami/qq-chat-exporter&max=12&columns=12" width="125" />
</a>
EOFMARKER
          
          echo "已为版本 ${VERSION} 生成发布说明"
      
      - name: "[5/5] 创建 GitHub Release"
        uses: softprops/action-gh-release@v1
        with:
          name: ${{ github.ref_name }}
          body_path: RELEASE_NOTES.md
          files: release-files/*
          draft: false
          prerelease: ${{ contains(github.ref_name, 'alpha') || contains(github.ref_name, 'beta') || contains(github.ref_name, 'rc') }}
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: "[x] 发布完成"
        run: |
          echo "========================================="
          echo "版本 ${{ github.ref_name }} 发布成功！"
          echo "========================================="
          echo "发布的文件："
          echo "- ✅ NapCat-QCE-Windows-x64-${{ github.ref_name }}.zip (Shell)"
          echo "- ✅ NapCat-QCE-Linux-x64-${{ github.ref_name }}.tar.gz (Shell)"
          echo "- ✅ NapCat-Framework-QCE-${{ github.ref_name }}.zip (Framework)"
          echo "========================================="
