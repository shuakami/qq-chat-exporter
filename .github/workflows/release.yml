name: è‡ªåŠ¨å‘å¸ƒRelease

on:
  push:
    tags:
      - 'v[3-9].*.*'
      - 'v[1-9][0-9].*.*'

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: è®¾ç½®GoçŽ¯å¢ƒ
      uses: actions/setup-go@v5
      with:
        go-version: '1.24'

    - name: è®¾ç½®Node.jsçŽ¯å¢ƒ
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: å®‰è£…å‰ç«¯ä¾èµ–
      run: npm ci

    - name: æž„å»ºå‰ç«¯èµ„æº
      run: npm run build

    - name: èŽ·å–ç‰ˆæœ¬ä¿¡æ¯
      id: get_version
      run: |
        VERSION=${GITHUB_REF#refs/tags/}
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "ç‰ˆæœ¬å·: $VERSION"

    - name: æž„å»ºGoåº”ç”¨ç¨‹åº
      run: |
        # åˆ›å»ºæž„å»ºç›®å½•
        mkdir -p build/binaries
        
        # Windows amd64
        GOOS=windows GOARCH=amd64 go build -ldflags="-s -w" -o build/binaries/qq-chat-exporter-windows-amd64.exe .
        
        # Windows arm64
        GOOS=windows GOARCH=arm64 go build -ldflags="-s -w" -o build/binaries/qq-chat-exporter-windows-arm64.exe .
        
        # Linux amd64
        GOOS=linux GOARCH=amd64 go build -ldflags="-s -w" -o build/binaries/qq-chat-exporter-linux-amd64 .
        
        # Linux arm64
        GOOS=linux GOARCH=arm64 go build -ldflags="-s -w" -o build/binaries/qq-chat-exporter-linux-arm64 .
        
        # macOS amd64
        GOOS=darwin GOARCH=amd64 go build -ldflags="-s -w" -o build/binaries/qq-chat-exporter-darwin-amd64 .
        
        # macOS arm64 (Apple Silicon)
        GOOS=darwin GOARCH=arm64 go build -ldflags="-s -w" -o build/binaries/qq-chat-exporter-darwin-arm64 .

    - name: éªŒè¯æž„å»ºæ–‡ä»¶
      run: |
        echo "éªŒè¯æž„å»ºçš„æ–‡ä»¶ï¼š"
        ls -la build/binaries/
        file build/binaries/* || true

    - name: åˆ›å»ºå‘å¸ƒåŒ…
      run: |
        # åˆ›å»ºå‘å¸ƒç›®å½•
        mkdir -p dist/packages
        
        # å®šä¹‰å¹³å°æ•°ç»„
        declare -A platforms=(
          ["windows-amd64"]="qq-chat-exporter-windows-amd64.exe"
          ["windows-arm64"]="qq-chat-exporter-windows-arm64.exe"
          ["linux-amd64"]="qq-chat-exporter-linux-amd64"
          ["linux-arm64"]="qq-chat-exporter-linux-arm64"
          ["darwin-amd64"]="qq-chat-exporter-darwin-amd64"
          ["darwin-arm64"]="qq-chat-exporter-darwin-arm64"
        )
        
        # ä¸ºæ¯ä¸ªå¹³å°åˆ›å»ºå‘å¸ƒåŒ…
        for platform in "${!platforms[@]}"; do
          binary="${platforms[$platform]}"
          package_dir="dist/packages/qq-chat-exporter-$platform"
          
          echo "åˆ›å»º $platform å‘å¸ƒåŒ…..."
          
          # åˆ›å»ºåŒ…ç›®å½•
          mkdir -p "$package_dir"
          
          # å¤åˆ¶å¯æ‰§è¡Œæ–‡ä»¶
          cp "build/binaries/$binary" "$package_dir/"
          chmod +x "$package_dir/$binary" 2>/dev/null || true
          
          # å¤åˆ¶èµ„æºæ–‡ä»¶
          cp -r public "$package_dir/"
          cp -r styles "$package_dir/"
          cp README.md "$package_dir/"
          cp config.example.yaml "$package_dir/"
          
          # åˆ›å»ºåŽ‹ç¼©åŒ…
          cd dist/packages
          if [[ $platform == *"windows"* ]]; then
            zip -r "qq-chat-exporter-$platform.zip" "qq-chat-exporter-$platform"
          else
            tar -czf "qq-chat-exporter-$platform.tar.gz" "qq-chat-exporter-$platform"
          fi
          cd ../..
          
          echo "âœ… $platform åŒ…åˆ›å»ºå®Œæˆ"
        done

    - name: ç”Ÿæˆæ›´æ–°æ—¥å¿—
      id: changelog
      run: |
        # èŽ·å–æœ€æ–°çš„æ ‡ç­¾
        PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^)
        
        # ç”Ÿæˆæ›´æ–°æ—¥å¿—
        echo "## ðŸš€ æ›´æ–°å†…å®¹" > CHANGELOG.md
        echo "" >> CHANGELOG.md
        
        if [ -n "$PREVIOUS_TAG" ]; then
          echo "### ðŸ“ æäº¤è®°å½• ($PREVIOUS_TAG..${{ steps.get_version.outputs.version }})" >> CHANGELOG.md
          git log --pretty=format:"- %s (%h)" $PREVIOUS_TAG..HEAD >> CHANGELOG.md
        else
          echo "### ðŸ“ æäº¤è®°å½•" >> CHANGELOG.md
          git log --pretty=format:"- %s (%h)" >> CHANGELOG.md
        fi
        
        echo "" >> CHANGELOG.md
        echo "## ðŸ“¦ ä¸‹è½½æ–‡ä»¶è¯´æ˜Ž" >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "- **Windowsç”¨æˆ·**: ä¸‹è½½ \`qq-chat-exporter-windows-amd64.zip\` (Intel/AMD) æˆ– \`qq-chat-exporter-windows-arm64.zip\` (ARM)" >> CHANGELOG.md
        echo "- **macOSç”¨æˆ·**: ä¸‹è½½ \`qq-chat-exporter-darwin-amd64.tar.gz\` (Intel) æˆ– \`qq-chat-exporter-darwin-arm64.tar.gz\` (Apple Silicon)" >> CHANGELOG.md
        echo "- **Linuxç”¨æˆ·**: ä¸‹è½½ \`qq-chat-exporter-linux-amd64.tar.gz\` (x86_64) æˆ– \`qq-chat-exporter-linux-arm64.tar.gz\` (ARM64)" >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "## ðŸ”§ ä½¿ç”¨æ–¹æ³•" >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "1. ä¸‹è½½å¯¹åº”æ‚¨ç³»ç»Ÿçš„åŽ‹ç¼©åŒ…" >> CHANGELOG.md
        echo "2. è§£åŽ‹åˆ°ä»»æ„ç›®å½•" >> CHANGELOG.md
        echo "4. åŒå‡»æ‰§è¡Œå°±å¯ä»¥å¼€å§‹ä½¿ç”¨äº†" >> CHANGELOG.md

    - name: åˆ›å»ºGitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.get_version.outputs.version }}
        name: "QQèŠå¤©è®°å½•å¯¼å‡ºå™¨ ${{ steps.get_version.outputs.version }}"
        body_path: CHANGELOG.md
        draft: false
        prerelease: false
        files: |
          dist/packages/*.zip
          dist/packages/*.tar.gz

    - name: å‘å¸ƒå®Œæˆé€šçŸ¥
      run: |
        echo "ðŸŽ‰ Release ${{ steps.get_version.outputs.version }} å‘å¸ƒæˆåŠŸ!"
        echo "ðŸ“¦ å·²ä¸Šä¼ ä»¥ä¸‹æ–‡ä»¶:"
        ls -la dist/packages/*.zip dist/packages/*.tar.gz 2>/dev/null || true